name: Continuous integration
on: 
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  GODOT_VERSION: "3.x"
  SCONS_CACHE: "${{ github.workspace }}/.scons-cache"

jobs:
  build:
    name: Build (macOS)
    runs-on: "macos-14"  # Use macOS-14 for Apple Silicon support

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.x
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Cache SCons build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SCONS_CACHE }}
            godot/.scons_cache
            godot/bin
          key: ${{ runner.os }}-scons-${{ hashFiles('godot/**/*.cpp', 'godot/**/*.h') }}
          restore-keys: |
            ${{ runner.os }}-scons-

      - name: Cache Godot headers
        uses: actions/cache@v4
        with:
          path: |
            godot/bin/*.a
            ios_plugins/**/*.h
          key: ${{ runner.os }}-godot-headers-${{ env.GODOT_VERSION }}-${{ hashFiles('godot/version.py') }}
          restore-keys: |
            ${{ runner.os }}-godot-headers-${{ env.GODOT_VERSION }}-

      - name: Install Python dependencies
        run: |
          python -c "import sys; print(sys.version)"
          python -m pip install --upgrade pip
          python -m pip install scons
          python --version
          scons --version

      - name: Make scripts executable
        run: chmod +x ./scripts/*

      - name: Ensure bin directory exists
        run: mkdir -p bin

      - name: Generate Headers
        run: |
          # Check if headers already exist in cache
          if [ ! -f "godot/bin/libgodot.iphone.opt.arm64.a" ]; then
            echo "Generating Godot headers..."
            ./scripts/generate_headers.sh ${{ env.GODOT_VERSION }} || true
          else
            echo "Using cached Godot headers"
          fi

      - name: Compile Plugins
        run: |
          # Set SCons cache directory
          export SCONS_CACHE=${{ env.SCONS_CACHE }}
          echo "SCons cache directory: $SCONS_CACHE"
          
          ./scripts/release_xcframework.sh ${{ env.GODOT_VERSION }}
          ls -l bin/release

      - name: Reorganize for distribution
        run: |
          echo "Reorganizing directory structure for distribution..."
          
          # Create final distribution structure (res://ios/plugins/)
          mkdir -p bin/dist/godot3_taptap/ios/plugins/godot3_taptap
          mkdir -p bin/dist/godot3_taptap/addons
          
          # Copy XCFrameworks and .gdip to ios/plugins
          cp -r bin/release/godot3_taptap/*.xcframework bin/dist/godot3_taptap/ios/plugins/godot3_taptap/
          cp bin/release/godot3_taptap/godot3_taptap.gdip bin/dist/godot3_taptap/ios/plugins/godot3_taptap/
          
          # Copy TapTap SDK frameworks to plugin directory (embedded dependencies)
          cp -r plugins/godot3_taptap/sdk bin/dist/godot3_taptap/ios/plugins/godot3_taptap/
          
          # Copy addons directory (includes key generation tools)
          cp -r addons/godot3_taptap bin/dist/godot3_taptap/addons/godot3_taptap
          
          echo "Distribution structure created successfully"

      - name: List release structure
        run: |
          echo "Distribution directory structure:"
          find bin/dist -type d
          echo ""
          echo "Files in distribution:"
          find bin/dist -type f

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot3_taptap-ios-plugin-${{ github.sha }}
          path: bin/dist/godot3_taptap/
          retention-days: 14
          if-no-files-found: error
          compression-level: 6

      - name: Create build summary
        run: |
          echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Godot Version:** ${{ env.GODOT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh bin/release/godot3_taptap/*.xcframework >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
